{% extends "base.html" %}

{% block title %}é—®ç­”æµ‹è¯• - LLM æµ‹è¯•å·¥å…·{% endblock %}

{% block content %}
<div class="panel">
    <div class="panel-title">
        <span style="font-size: 24px;">ğŸ’¬</span>
        <h2>é—®ç­”æµ‹è¯•é…ç½®</h2>
    </div>
    <form id="testForm">
        <div class="form-group">
            <label>API åœ°å€</label>
            <input type="text" name="api_url" value="http://localhost:1234/v1/chat/completions" required>
            <div class="hint">LM Studioé»˜è®¤: localhost:1234</div>
        </div>
        <div class="form-group">
            <label>æ¨¡å‹åç§°</label>
            <input type="text" name="model_name" value="local-model">
        </div>
        <div class="row">
            <div class="form-group">
                <label>Temperature</label>
                <input type="number" name="temperature" value="0.7" step="0.1" min="0" max="2" required>
            </div>
            <div class="form-group">
                <label>æœ€å¤§Tokenæ•°</label>
                <input type="number" name="max_tokens" value="2000" required>
            </div>
        </div>
        <div class="row">
            <div class="form-group">
                <label>è¶…æ—¶æ—¶é—´(ç§’)</label>
                <input type="number" name="timeout" value="60" required>
            </div>
            <div class="form-group">
                <label>è¯·æ±‚é—´éš”(ç§’)</label>
                <input type="number" name="sleep_interval" value="1" step="0.1" required>
            </div>
        </div>
        <div class="form-group">
            <label>æé—®æ–¹å¼</label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="question_mode" value="file" checked>
                    <span>ä»æ–‡ä»¶è¯»å–</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="question_mode" value="input">
                    <span>æ‰‹åŠ¨è¾“å…¥</span>
                </label>
            </div>
        </div>
        <div class="form-group" id="fileInputGroup">
            <label>é—®é¢˜æ–‡ä»¶è·¯å¾„</label>
            <input type="text" name="questions_file" value="questions.xlsx">
        </div>
        <div class="form-group" id="manualInputGroup" style="display: none;">
            <label>è¾“å…¥é—®é¢˜ï¼ˆæ¯è¡Œä¸€ä¸ªé—®é¢˜ï¼‰</label>
            <textarea name="questions_text" rows="6" placeholder="è¯·è¾“å…¥é—®é¢˜ï¼Œæ¯è¡Œä¸€ä¸ªé—®é¢˜&#10;ä¾‹å¦‚ï¼š&#10;ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ&#10;å¦‚ä½•å­¦ä¹ ç¼–ç¨‹ï¼Ÿ"></textarea>
        </div>
        <button type="submit" id="startBtn">å¼€å§‹æµ‹è¯•</button>
    </form>
</div>

<div class="panel result-panel">
    <div class="panel-title">
        <span style="font-size: 24px;">ğŸ“Š</span>
        <h2>æµ‹è¯•ç»“æœ</h2>
    </div>
    <div id="statsContainer" style="display: none;">
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="statProgress">0/0</div>
                <div class="stat-label">è¿›åº¦</div>
            </div>
            <div class="stat-card success">
                <div class="stat-value" id="statSuccess">0</div>
                <div class="stat-label">æˆåŠŸ</div>
            </div>
            <div class="stat-card failed">
                <div class="stat-value" id="statFailed">0</div>
                <div class="stat-label">å¤±è´¥</div>
            </div>
        </div>
    </div>
    <div class="output" id="output">
        <div class="empty">ç­‰å¾…å¼€å§‹æµ‹è¯•...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const form = document.getElementById('testForm');
    const output = document.getElementById('output');
    const startBtn = document.getElementById('startBtn');
    const statsContainer = document.getElementById('statsContainer');
    const fileInputGroup = document.getElementById('fileInputGroup');
    const manualInputGroup = document.getElementById('manualInputGroup');
    const questionModeRadios = document.querySelectorAll('input[name="question_mode"]');
    
    let stats = { total: 0, current: 0, success: 0, failed: 0 };
    let tooltip = null;

    questionModeRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            if (e.target.value === 'file') {
                fileInputGroup.style.display = 'block';
                manualInputGroup.style.display = 'none';
            } else {
                fileInputGroup.style.display = 'none';
                manualInputGroup.style.display = 'block';
            }
        });
    });

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function createTooltip() {
        if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            document.body.appendChild(tooltip);
        }
        return tooltip;
    }

    function showTooltip(element, text) {
        const tip = createTooltip();
        tip.textContent = text;
        tip.style.display = 'block';
        const rect = element.getBoundingClientRect();
        const tipRect = tip.getBoundingClientRect();
        let left = rect.left;
        let top = rect.bottom + 8;
        if (left + tipRect.width > window.innerWidth - 20) left = window.innerWidth - tipRect.width - 20;
        if (left < 20) left = 20;
        if (top + tipRect.height > window.innerHeight - 20) top = rect.top - tipRect.height - 8;
        if (top < 20) top = 20;
        tip.style.left = left + 'px';
        tip.style.top = top + 'px';
    }

    function hideTooltip() {
        if (tooltip) tooltip.style.display = 'none';
    }

    function addLog(message, type) {
        const div = document.createElement('div');
        div.className = `log-item log-${type}`;
        div.innerHTML = message;
        output.appendChild(div);
        const answerTexts = div.querySelectorAll('.answer-text');
        answerTexts.forEach(el => {
            el.addEventListener('mouseenter', function() {
                showTooltip(this, this.getAttribute('data-full-text'));
            });
            el.addEventListener('mouseleave', hideTooltip);
        });
        output.scrollTop = output.scrollHeight;
    }

    function updateStats() {
        document.getElementById('statProgress').textContent = `${stats.current}/${stats.total}`;
        document.getElementById('statSuccess').textContent = stats.success;
        document.getElementById('statFailed').textContent = stats.failed;
    }

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const questionMode = form.question_mode.value;
        if (questionMode === 'file' && !form.questions_file.value.trim()) {
            alert('è¯·è¾“å…¥é—®é¢˜æ–‡ä»¶è·¯å¾„');
            return;
        }
        if (questionMode === 'input' && !form.questions_text.value.trim()) {
            alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªé—®é¢˜');
            return;
        }
        
        output.innerHTML = '';
        statsContainer.style.display = 'block';
        startBtn.disabled = true;
        startBtn.classList.add('loading');
        startBtn.textContent = 'æµ‹è¯•ä¸­...';
        stats = { total: 0, current: 0, success: 0, failed: 0 };
        
        const formData = new FormData(form);
        const params = new URLSearchParams(formData).toString();
        const eventSource = new EventSource(`/stream?${params}`);
        
        eventSource.addEventListener('message', (e) => {
            const data = JSON.parse(e.data);
            if (data.type === 'start') {
                stats.total = data.total;
                addLog(`å¼€å§‹æµ‹è¯•ï¼Œå…± ${data.total} ä¸ªé—®é¢˜`, 'start');
                updateStats();
            }
            else if (data.type === 'question') {
                stats.current = data.index;
                addLog(`[${data.index}/${data.total}] æé—®: ${data.question}`, 'question');
                updateStats();
            }
            else if (data.type === 'answer') {
                if (data.success) {
                    stats.success++;
                    const fullAnswer = data.answer;
                    const preview = fullAnswer.substring(0, 50);
                    const needsTruncate = fullAnswer.length > 50;
                    const answerHtml = needsTruncate 
                        ? `âœ“ å›ç­”æˆåŠŸ (${data.latency}s):<br><span class="answer-text" data-full-text="${escapeHtml(fullAnswer)}" title="é¼ æ ‡æ‚¬æµ®æŸ¥çœ‹å®Œæ•´ç­”æ¡ˆ">${escapeHtml(preview)}...</span>`
                        : `âœ“ å›ç­”æˆåŠŸ (${data.latency}s):<br>${escapeHtml(fullAnswer)}`;
                    addLog(answerHtml, 'answer');
                } else {
                    stats.failed++;
                    addLog(`âœ— å›ç­”å¤±è´¥: ${data.error}`, 'error');
                }
                updateStats();
            }
            else if (data.type === 'skip') {
                stats.current = data.index;
                stats.failed++;
                addLog(`[${data.index}/${data.total}] è·³è¿‡ç©ºé—®é¢˜`, 'error');
                updateStats();
            }
            else if (data.type === 'complete') {
                addLog(`âœ… æµ‹è¯•å®Œæˆï¼æˆåŠŸ ${data.success_count}/${data.total}`, 'complete');
                addLog(`<a href="/download/${data.report_path}">ğŸ“¥ ç‚¹å‡»ä¸‹è½½æµ‹è¯•æŠ¥å‘Š</a>`, 'complete');
                startBtn.disabled = false;
                startBtn.classList.remove('loading');
                startBtn.textContent = 'å¼€å§‹æµ‹è¯•';
                eventSource.close();
            }
            else if (data.type === 'error') {
                addLog(`âŒ é”™è¯¯: ${data.message}`, 'error');
                startBtn.disabled = false;
                startBtn.classList.remove('loading');
                startBtn.textContent = 'å¼€å§‹æµ‹è¯•';
                eventSource.close();
            }
        });
        
        eventSource.addEventListener('error', () => {
            addLog('âŒ è¿æ¥ä¸­æ–­', 'error');
            startBtn.disabled = false;
            startBtn.classList.remove('loading');
            startBtn.textContent = 'å¼€å§‹æµ‹è¯•';
            eventSource.close();
        });
    });
</script>
{% endblock %}
