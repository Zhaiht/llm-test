{% extends "base.html" %}

{% block title %}å‹åŠ›æµ‹è¯• - LLM æµ‹è¯•å·¥å…·{% endblock %}

{% block content %}
<div class="panel">
    <div class="panel-title">
        <span style="font-size: 24px;">âš¡</span>
        <h2>å‹åŠ›æµ‹è¯•é…ç½®</h2>
    </div>
    <form id="stressForm">
        <div class="form-group">
            <label>ç›®æ ‡APIåœ°å€</label>
            <input type="text" name="target_url" value="http://localhost:1234" required>
            <div class="hint">è¦å‹æµ‹çš„æœåŠ¡å™¨åœ°å€</div>
        </div>
        <div class="form-group">
            <label>æµ‹è¯•æ¥å£</label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="test_endpoint" value="models" checked>
                    <span>/v1/models</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="test_endpoint" value="chat">
                    <span>/v1/chat/completions</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="test_endpoint" value="both">
                    <span>æ··åˆæµ‹è¯•</span>
                </label>
            </div>
        </div>
        <div class="row">
            <div class="form-group">
                <label>å¹¶å‘ç”¨æˆ·æ•°</label>
                <input type="number" name="users" value="10" min="1" required>
                <div class="hint">åŒæ—¶å‘èµ·è¯·æ±‚çš„ç”¨æˆ·æ•°</div>
            </div>
            <div class="form-group">
                <label>å¯åŠ¨é€Ÿç‡ (ç”¨æˆ·/ç§’)</label>
                <input type="number" name="spawn_rate" value="2" min="1" required>
                <div class="hint">æ¯ç§’å¯åŠ¨çš„ç”¨æˆ·æ•°</div>
            </div>
        </div>
        <div class="row">
            <div class="form-group">
                <label>è¿è¡Œæ—¶é•¿ (ç§’)</label>
                <input type="number" name="duration" value="60" min="1" required>
                <div class="hint">å‹æµ‹æŒç»­æ—¶é—´</div>
            </div>
            <div class="form-group">
                <label>è¯·æ±‚é—´éš” (ç§’)</label>
                <input type="number" name="wait_time" value="1" min="0.1" step="0.1" required>
                <div class="hint">æ¯ä¸ªè¯·æ±‚ä¹‹é—´çš„ç­‰å¾…æ—¶é—´</div>
            </div>
        </div>
        <div class="form-group" id="chatConfigGroup" style="display: none;">
            <label>èŠå¤©æ¨¡å‹åç§°</label>
            <input type="text" name="model_name" value="local-model">
        </div>
        <button type="submit" id="stressBtn">å¼€å§‹å‹æµ‹</button>
    </form>
</div>

<div class="panel result-panel">
    <div class="panel-title">
        <span style="font-size: 24px;">ğŸ“ˆ</span>
        <h2>å‹æµ‹ç»“æœ</h2>
    </div>
    <div id="stressStatsContainer" style="display: none;">
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="stressRPS">0</div>
                <div class="stat-label">RPS (è¯·æ±‚/ç§’)</div>
            </div>
            <div class="stat-card success">
                <div class="stat-value" id="stressSuccess">0</div>
                <div class="stat-label">æˆåŠŸè¯·æ±‚</div>
            </div>
            <div class="stat-card failed">
                <div class="stat-value" id="stressFailed">0</div>
                <div class="stat-label">å¤±è´¥è¯·æ±‚</div>
            </div>
        </div>
    </div>
    <div class="output" id="stressOutput">
        <div class="empty">é…ç½®å‚æ•°åå¼€å§‹å‹æµ‹...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const stressForm = document.getElementById('stressForm');
    const stressOutput = document.getElementById('stressOutput');
    const stressBtn = document.getElementById('stressBtn');
    const stressStatsContainer = document.getElementById('stressStatsContainer');
    const chatConfigGroup = document.getElementById('chatConfigGroup');
    const testEndpointRadios = document.querySelectorAll('input[name="test_endpoint"]');
    
    testEndpointRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            chatConfigGroup.style.display = (e.target.value === 'chat' || e.target.value === 'both') ? 'block' : 'none';
        });
    });

    function addStressLog(message, type) {
        const div = document.createElement('div');
        div.className = `log-item log-${type}`;
        div.textContent = message;
        stressOutput.appendChild(div);
        stressOutput.scrollTop = stressOutput.scrollHeight;
    }

    stressForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        console.log('è¡¨å•æäº¤äº‹ä»¶è§¦å‘');
        
        stressOutput.innerHTML = '';
        stressStatsContainer.style.display = 'block';
        stressBtn.disabled = true;
        stressBtn.classList.add('loading');
        stressBtn.textContent = 'å‹æµ‹ä¸­...';
        
        const formData = new FormData(stressForm);
        const params = new URLSearchParams(formData).toString();
        
        console.log('è¯·æ±‚å‚æ•°:', params);
        
        addStressLog('æ­£åœ¨å¯åŠ¨å‹åŠ›æµ‹è¯•...', 'start');
        addStressLog('æç¤ºï¼šé¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…', 'question');
        
        const url = `/stress_test?${params}`;
        console.log('è¯·æ±‚URL:', url);
        
        fetch(url)
            .then(response => {
                console.log('æ”¶åˆ°å“åº”:', response.status);
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || 'è¯·æ±‚å¤±è´¥');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('å“åº”æ•°æ®:', data);
                if (data.status === 'success') {
                    addStressLog(`âœ… å‹æµ‹å®Œæˆï¼`, 'complete');
                    addStressLog(`æ€»è¯·æ±‚æ•°: ${data.total_requests}`, 'answer');
                    addStressLog(`æˆåŠŸ: ${data.success_count}, å¤±è´¥: ${data.failed_count}`, 'answer');
                    addStressLog(`å¹³å‡RPS: ${data.avg_rps}`, 'answer');
                    addStressLog(`å¹³å‡å“åº”æ—¶é—´: ${data.avg_response_time}ms`, 'answer');
                    addStressLog(`ğŸ“„ è¯¦ç»†æŠ¥å‘Šå·²ç”Ÿæˆ: reports/locust_report.html`, 'complete');
                    document.getElementById('stressRPS').textContent = data.avg_rps;
                    document.getElementById('stressSuccess').textContent = data.success_count;
                    document.getElementById('stressFailed').textContent = data.failed_count;
                } else {
                    addStressLog(`âŒ é”™è¯¯: ${data.message}`, 'error');
                    if (data.message.includes('Locustæœªå®‰è£…')) {
                        addStressLog('ğŸ’¡ è§£å†³æ–¹æ³•ï¼šåœ¨ç»ˆç«¯è¿è¡Œ pip install locust', 'question');
                    }
                }
            })
            .catch(error => {
                console.error('è¯·æ±‚é”™è¯¯:', error);
                addStressLog(`âŒ å‹æµ‹å¤±è´¥: ${error.message}`, 'error');
                addStressLog('ğŸ’¡ è¯·æ£€æŸ¥ï¼š', 'question');
                
                if (error.message.includes('ä¾èµ–åŒ…ç¼ºå¤±') || error.message.includes('ModuleNotFoundError')) {
                    addStressLog('1. å®‰è£…å®Œæ•´ä¾èµ–ï¼špip install locust zope.event', 'question');
                    addStressLog('2. æˆ–è€…é‡æ–°å®‰è£…ï¼špip uninstall locust && pip install locust', 'question');
                } else {
                    addStressLog('1. Locustæ˜¯å¦å·²å®‰è£… (pip install locust)', 'question');
                    addStressLog('2. ç›®æ ‡æœåŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œ', 'question');
                    addStressLog('3. æŸ¥çœ‹ç»ˆç«¯æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯', 'question');
                }
            })
            .finally(() => {
                console.log('è¯·æ±‚å®Œæˆ');
                stressBtn.disabled = false;
                stressBtn.classList.remove('loading');
                stressBtn.textContent = 'å¼€å§‹å‹æµ‹';
            });
    });
</script>
{% endblock %}
